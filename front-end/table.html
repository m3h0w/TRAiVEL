<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
<script src="/datamaps.world.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
<div id="flightsTable"></div>
<div id="container" style="position: relative; width: 100%; height: 100%;">
</div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  async function get_data(){
    do_loading()
    await axios.get('http://127.0.0.1:8001/get_data')
    .then(function(response){
      responseData = response.data
      // names_list = data.map(el => el.name)
      console.log(responseData); // ex.: { user: 'Your User'}
      console.log(response.status); // ex.: 200
      // document.getElementById("personas").innerHTML = data;

      // document.getElementById('personas').appendChild(makeRB(data));
      return
    });
    all(responseData);
    return responseData;
  }
  get_data();

  function do_loading(){
    var mydiv = document.getElementById("container");
    mydiv.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
  }

  function all(responseData){
    var mydiv = document.getElementById("container");
    mydiv.innerHTML = "";
    var colors = [
      "#FF0000",
      "#FF1100",
      "#FF2300",
      "#FF3400",
      "#FF4600",
      "#FF5700",
      "#FF6900",
      "#FF7B00",
      "#FF8C00",
      "#FF9E00",
      "#FFAF00",
      "#FFC100",
      "#FFD300",
      "#FFE400",
      "#FFF600",
      "#F7FF00",
      "#E5FF00",
      "#D4FF00",
      "#C2FF00",
      "#B0FF00",
      "#9FFF00",
      "#8DFF00",
      "#7CFF00",
      "#6AFF00",
      "#58FF00",
      "#47FF00",
      "#35FF00",
      "#24FF00",
      "#12FF00",
      "#00FF00"
    ]

  var minSentiment = 0;
  var maxSentiment = 1

  function mapIntToColor(colors_list, value){
    var colors_n = colors_list.length - 1;
    return colors[Math.ceil(value * colors_list.length) - 1]
  }

  var colorSetup = Object.keys(responseData).reduce(function(previous, current) {
    previous[current] = mapIntToColor(colors, responseData[current]["sentiment"]);
    return previous;
  }, {});

  var fillsSetup = Object.keys(responseData).reduce(function(previous, current) {
    previous[current] = mapIntToColor(colors, responseData[current]["sentiment"]);
    return previous;
  }, {});
  fillsSetup['defaultFill'] = "#AAA"

  var dataSetup = Object.keys(responseData).reduce(function(previous, current) {
    previous[current] = { fillKey: current };
    return previous;
  }, {});

  var map = new Datamap({setProjection: function(element) {
    var projection = d3.geo.equirectangular()
        .center([10, 50])
        .rotate([4.4, 0])
        .scale(1500)
        .translate([element.offsetWidth / 2, element.offsetHeight / 2]);
      var path = d3.geo.path()
        .projection(projection);
      return {path: path, projection: projection};
  },
  fills: fillsSetup,
  data: dataSetup,
  element: document.getElementById('container')});
  }

   
</script>